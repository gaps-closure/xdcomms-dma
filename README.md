# XDCOMMS Library

Partitioned application programs use the CLOSURE Cross-Domain Communication (XDCOMMS) library to communicate data between enclaves (via Cross-Domain Guards). 


## XDCOMMS API

The XDCOMMS-lib maintains the same API as the Hardware Abstraction Layer (HAL).
The calls to these API functions in the partitioned applications are 
automatically generated by the CLOSURE toolchain (RPC generator).

The API uses HAL tag structures to identify the abstract communication channels
with three orthogonal 32-bit unsigned identifiers:

```
typedef struct _tag {
  uint32_t  mux;  // session multiplexing handle for a unidirectional APP flow
  uint32_t  sec;  // identifies a CDG security policy used to processing APP data
  uint32_t  typ;  // identifies APP data type (based on DFDL xsd definition)
} gaps_tag;
```

As the CLOSURE codecs handle serialization and de-serialization, applications can 
send and receive data by simply passing pointers to a) in-memory data structures 
and b) the tag (see above) for data item to be sent or received. 
In particular, XDCOMMS-lib provides: 
a) an asynchronous send, 
b) a blocking receive (until a message matching the specified tag is received), and 
c) a receive which supports a timeout (specified in the xdc_sub_socket_non_blocking() call). 

```
void  xdc_asyn_send(void *socket, void *adu, gaps_tag *tag);
int   xdc_recv(void *socket, void *adu, gaps_tag *tag);
void  xdc_blocking_recv(void *socket, void *adu, gaps_tag *tag);
```

Unlike HAL, the socket pointer is needed by XDCOMMS-lib, so may be specified as NULL.
In addition to the send/receive calls, other calls specify the API log level, 
the receive timeout and the codec function (generated by CLOSURE):

```
void  xdc_log_level(int new_level);
void *xdc_sub_socket_non_blocking(gaps_tag tag, int timeout);
void  xdc_register(codec_func_ptr encode, codec_func_ptr decode, int typ);
```

## XDCOMMS Supported Cross-Domain Guards

XDCOMMS-lib current version (version 0.5, October 2023) supports three main types of CDG:
- **GE-MIND**: Communicating with a proxy DMA driver using IOCTL commands, which in turn communicates with the XILINX AXI DMA/MCDMA driver on the GE MIND ZCU102 FPGA board.
- **INTEL-ESCAPE**: Copying data to and from shared memory mapped regions on the ESCAPE FPGA board. 
- **X-ARBITOR**: Reading and writing files with the help of the X-ARBITOR send and receive proxies.

In addition, XDCOMMS-lib can be tested on a single host computer using: 
- Pseudo driver: which emulates the proxy DMA driver.
- Shared Memory (SHM) mapped regions of the host computer: as a stand-in for the ESCAPE FPGA board. 
- Files in directories on the host computer: as stand-in for the X-ARBITOR.


## XDCOMMS Installation
To install the xdcomms library, together with the test application and pseudo driver run the following commands:
```
  git clone git@github.com:gaps-closure/xdcomms-dma
  cd xdcomms-dma/
  make clean
  make 
```


## XDCOMMS Configuration

XDCOMMS-lib uses three types of configuration infomration, from:
a) device header files, 
b) a JSON configuration file, and
c) UNIX environment variables.

### Device Header Files
For each types of supported CDG, XDCOMMS-lib has a header file 
that defines the communication device configuration:

- **DMA**: [dma-proxy.h](./dma-proxy.h). 
- **SHM**: [shm.h](./shm.h). 
- **FILE**: [file_info.h](./file_info.h). 


### JSON Configuration File

XDCOMMS-lib reads the one-way channel definitions 
(including definition of channel tags from a JSON configuration file.
This JSON file is normally autognerated by the CLOSURE tools as 'xdcomms.ini'.
A simple example that supports two types of client requests/responses 
(with position or raw information) between two enclave (orange and green) 
is the test application file 
[xdconf_app_req_rep.json](./test_app/xdconf_app_req_rep.json).

 
### Environment Variables

Selection of device configuration is done through UNIX environment variables specified when running the partitioned application.

```
                                                       DEFAULTS
ENVIR. VARIABLE  Description                           dma,                file,      shm       
---------------  ------------------------------------  -------------------------------------
CONFIG_FILE      JSON conifuration file                REQUIRED
DEV_NAME_RX      Name of receive device^               /dev/dma_proxy_rx, /tmp/xdc, /dev/mem  
DEV_NAME_TX      Name of transmit device^              /dev/dma_proxy_tx, /tmp/xdc, /dev/mem
DEV_TYPE_RX      Receiver Device type                  dma
DEV_TYPE_TX      Transmitter Device type               dma
ENCLAVE          Name of enclave (in CONFIG_FILE)      REQUIRED
LD_LIBRARY_PATH  Directory path to xdcomms library     LINUX OS PATH
SHM_WAIT4NEW     Wait for new client if non-zero       -,                  -,           0                   
XARB_IP          X-ARBITOR Proxy IP address            -,            192.168.100.101,   -        
XARB_PORT        X-ARBITOR Proxy TCP PORT              -,                  1124,        -
XDCLOGLEVEL      Log level: 0=TRACE, 1=DEBUG, 2=INFO   XDCOMMS API call: xdc_log_level()
---------------  ------------------------------------  -------------------------------------

^ Environmental varibale default depend on DEV_TYPE
- Environmental varibale is not used with given DEV_TYPE
```

The partioned application may have its own environmental varibales. For example, WEBSRV has:

```
ENVIR. VARIABLE  Description                           DEFAULTS      
---------------  ------------------------------------  ----------
CAMADDR          IP address of Video Camera            REQUIRED
MYADDR           IP address of this application        REQUIRED
```

Examples of the use of these environmental variables are given below for the:

- [Test Application](#running-the-test-application)
- [WEBSRV Application](#running-the-websrv-application)


## Running the Test Application

A test application is included with the xdcomms  
```
  cd ~/gaps/xdcomms-dma/test_app
```

### PSEUDO DMA (on a single host)
First, ensure that the psuedo driver is compiled and loaded:
```
    cd ~/gaps/xdcomms-dma/pseudo
    make
    sudo ./sue_donimous_unload
    sudo ./sue_donimous_load
    lsmod | grep sue
    cd ~/gaps/xdcomms-dma/test_app
```

Then we can run the test application 
```
ENCLAVE=orange CONFIG_FILE=xdconf_app_req_rep.json DEV_NAME_RX=sue_donimous_rx1 DEV_NAME_TX=sue_donimous_tx1 LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api ./app_req_rep -v -e 2 -l 1

ENCLAVE=green CONFIG_FILE=xdconf_app_req_rep.json DEV_NAME_RX=sue_donimous_rx0 DEV_NAME_TX=sue_donimous_tx0 LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api ./app_req_rep -v -l 1
```


### MIND DMA (on the XILINX board)
Note that the SERVER (orange on a53) must be started within 3 seconds after starting the CLIENT (green on the microblaze)
```
ENCLAVE=orange CONFIG_FILE=xdconf_app_req_rep.json XDCLOGLEVEL=0 ./app_req_rep -v -l 1 -e 2

ENCLAVE=green  CONFIG_FILE=xdconf_app_req_rep.json XDCLOGLEVEL=0 ./app_req_rep -v -l 1  
```


### ESCAPE SHM (on the ESCAPE board)
```
sudo ENCLAVE=orange CONFIG_FILE=xdconf_app_req_rep.json DEV_TYPE_RX=shm DEV_TYPE_TX=shm SHM_WAIT4NEW=1 LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api ./app_req_rep -e 2 -v -l 1

sudo ENCLAVE=green CONFIG_FILE=xdconf_app_req_rep.json DEV_TYPE_RX=shm DEV_TYPE_TX=shm LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api ./app_req_rep -v -l 1
```


### X-ARBITOR FILE (on a single host)
```
ENCLAVE=orange CONFIG_FILE=xdconf_app_req_rep.json DEV_TYPE_RX=file DEV_TYPE_TX=file LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api DEV_NAME_RX=/tmp/xdc/2 DEV_NAME_TX=/tmp/xdc/1 XARB_IP=1.2.3.4 ./app_req_rep -v -l 1 -e 2

ENCLAVE=green CONFIG_FILE=xdconf_app_req_rep.json DEV_TYPE_RX=file DEV_TYPE_TX=file LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api DEV_NAME_TX=/tmp/xdc/2 DEV_NAME_RX=/tmp/xdc/1 XARB_IP=1.2.3.5 ./app_req_rep -v -l 1
```


## Running the Websrv Application
The websrv application has been tested on all supported xdcomms environments.
Replace the IP addresses for MYADDR and CAMADDR with the correct ones for the experiment setup.

### INTEL ESCAPE SHM 
```
sudo CONFIG_FILE=../xdconf.ini LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api \
ENCLAVE=orange MYADDR=10.109.23.128 CAMADDR=10.109.23.151 SHM_WAIT4NEW=1 \
DEV_TYPE_RX=shm DEV_TYPE_TX=shm XDCLOGLEVEL=0 ./websrv

sudo CONFIG_FILE=../xdconf.ini LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api \
ENCLAVE=green \
DEV_TYPE_RX=shm DEV_TYPE_TX=shm XDCLOGLEVEL=0 ./websrv
```


### PSEUDO DMA (on a single host)
```
CONFIG_FILE=../xdconf.ini LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api \
ENCLAVE=orange MYADDR=10.109.23.128 CAMADDR=10.109.23.151 \
DEV_NAME_RX=sue_donimous_rx1 DEV_NAME_TX=sue_donimous_tx1 XDCLOGLEVEL=0 ./websrv

CONFIG_FILE=../xdconf.ini LD_LIBRARY_PATH=~/gaps/xdcomms-dma/api \
ENCLAVE=green \
DEV_NAME_RX=sue_donimous_rx0 DEV_NAME_TX=sue_donimous_tx0 XDCLOGLEVEL=0 ./websrv
```


### GD MIND DMA 
``` 
XDCLOGLEVEL=0 MYADDR=10.109.23.247 CAMADDR=10.109.23.151 ENCLAVE=orange CONFIG_FILE=xdconf.ini ./websrv-vid

XDCLOGLEVEL=0 ENCLAVE=green CONFIG_FILE=xdconf.ini ./websrv-web
```
